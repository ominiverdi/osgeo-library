<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Extraction Comparison - OSGeo Library</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .controls select, .controls button {
            padding: 10px 15px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .controls button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        .controls button:hover {
            background: #2980b9;
        }
        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .panel-header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        .panel-header.traditional {
            background: #e74c3c;
        }
        .panel-header.multimodal {
            background: #27ae60;
        }
        .panel-header.original {
            background: #3498db;
        }
        .panel-content {
            padding: 15px;
            max-height: 800px;
            overflow-y: auto;
        }
        .page-image {
            width: 100%;
            height: auto;
            border: 1px solid #eee;
        }
        .extraction-text {
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
        .section {
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .figure-item {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .figure-item .caption {
            font-weight: bold;
            color: #2980b9;
        }
        .figure-item .description {
            margin-top: 5px;
            font-style: italic;
            color: #555;
        }
        .key-concepts {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .concept-tag {
            background: #9b59b6;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        .citation-tag {
            background: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
        }
        .type-tag {
            background: #16a085;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 5px;
        }
        .extracted-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .extracted-image-item {
            background: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .extracted-image-item img {
            max-width: 100%;
            max-height: 150px;
            border: 1px solid #ddd;
        }
        .extracted-image-item .img-info {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }
        .visual-element {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }
        .visual-element.architecture_diagram { border-left-color: #9b59b6; }
        .visual-element.graph_chart { border-left-color: #e74c3c; }
        .visual-element.table { border-left-color: #f39c12; }
        .visual-element.results_figure { border-left-color: #27ae60; }
        .visual-element.map, .visual-element.satellite_image { border-left-color: #1abc9c; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 5px;
            margin-top: 5px;
        }
        .metric-item {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            font-size: 11px;
        }
        .metric-item .metric-name { font-weight: bold; }
        .metric-item .metric-value { color: #27ae60; }
        .model-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .model-badge.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
        }
        .model-badge.gemini { background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); }
        .model-badge.gemma { background: linear-gradient(135deg, #4285f4 0%, #ea4335 100%); }
        .model-badge.mistral { background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); }
        .model-badge.nemotron { background: linear-gradient(135deg, #76b900 0%, #1a1a1a 100%); }
        .model-badge.nova { background: linear-gradient(135deg, #ff9900 0%, #146eb4 100%); }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 11px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        @media (max-width: 1200px) {
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>PDF Extraction Comparison</h1>
    <p class="subtitle">Compare Traditional vs Multimodal extraction methods for scientific papers</p>
    
    <div class="controls">
        <select id="pdf-select">
            <option value="">-- Select PDF --</option>
        </select>
        <select id="page-select">
            <option value="">-- Select Page --</option>
        </select>
        <select id="model-filter">
            <option value="">-- All Models --</option>
        </select>
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
    </div>
    
    <div class="comparison-container">
        <!-- Original PDF Page -->
        <div class="panel">
            <div class="panel-header original">Original PDF Page</div>
            <div class="panel-content" id="original-panel">
                <div class="no-data">Select a PDF and page to view</div>
            </div>
        </div>
        
        <!-- Traditional Extraction -->
        <div class="panel">
            <div class="panel-header traditional">Traditional (PyMuPDF)</div>
            <div class="panel-content" id="traditional-panel">
                <div class="no-data">Select a PDF and page to view</div>
            </div>
        </div>
        
        <!-- Multimodal Extraction -->
        <div class="panel">
            <div class="panel-header multimodal" id="multimodal-header">Multimodal Extraction</div>
            <div class="panel-content" id="multimodal-panel">
                <div class="no-data">Select a PDF and page to view</div>
            </div>
        </div>
    </div>
    
    <script>
        let comparisonData = null;
        let currentPdf = null;
        let currentPage = 1;
        let currentModelFilter = '';
        
        async function loadData() {
            try {
                const response = await fetch('data/comparisons.json');
                comparisonData = await response.json();
                populatePdfSelect();
            } catch (e) {
                console.error('Failed to load comparison data:', e);
                document.getElementById('original-panel').innerHTML = 
                    '<div class="no-data">Error loading data. Make sure comparisons.json exists.</div>';
            }
        }
        
        function populatePdfSelect() {
            const select = document.getElementById('pdf-select');
            select.innerHTML = '<option value="">-- Select PDF --</option>';
            
            for (const pdfName in comparisonData.pdfs) {
                const option = document.createElement('option');
                option.value = pdfName;
                option.textContent = pdfName;
                select.appendChild(option);
            }
            
            select.addEventListener('change', (e) => {
                currentPdf = e.target.value;
                currentPage = 1;
                currentModelFilter = '';
                document.getElementById('model-filter').value = '';
                populateModelFilter();
                populatePageSelect();
                renderComparison();
            });
        }
        
        function populateModelFilter() {
            const select = document.getElementById('model-filter');
            select.innerHTML = '<option value="">-- All Models --</option>';
            
            if (!currentPdf || !comparisonData.pdfs[currentPdf]) return;
            
            const pages = comparisonData.pdfs[currentPdf].pages;
            const models = new Set();
            
            for (const pageNum in pages) {
                const modelDisplay = pages[pageNum].multimodal?.model_display;
                if (modelDisplay) {
                    models.add(modelDisplay);
                }
            }
            
            for (const model of Array.from(models).sort()) {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            }
            
            select.addEventListener('change', (e) => {
                currentModelFilter = e.target.value;
                populatePageSelect();
                renderComparison();
            });
        }
        
        function getFilteredPages(pages) {
            const pageNums = Object.keys(pages).map(Number).sort((a, b) => a - b);
            if (!currentModelFilter) {
                return pageNums.map(String);
            }
            return pageNums.filter(num => {
                const modelDisplay = pages[num].multimodal?.model_display;
                return modelDisplay === currentModelFilter;
            }).map(String);
        }
        
        function populatePageSelect() {
            const select = document.getElementById('page-select');
            select.innerHTML = '<option value="">-- Select Page --</option>';
            
            if (!currentPdf || !comparisonData.pdfs[currentPdf]) return;
            
            const pages = comparisonData.pdfs[currentPdf].pages;
            const filteredPages = getFilteredPages(pages);
            
            for (const pageNum of filteredPages) {
                const pageData = pages[pageNum];
                const modelName = pageData.multimodal?.model_display || '';
                const option = document.createElement('option');
                option.value = pageNum;
                option.textContent = modelName ? `Page ${pageNum} (${modelName})` : `Page ${pageNum}`;
                select.appendChild(option);
            }
            
            select.addEventListener('change', (e) => {
                currentPage = parseInt(e.target.value);
                renderComparison();
            });
            
            // Select first page
            if (filteredPages.length > 0) {
                currentPage = parseInt(filteredPages[0]);
                select.value = currentPage;
            }
        }
        
        function prevPage() {
            if (!currentPdf || !comparisonData.pdfs[currentPdf]) return;
            const pages = Object.keys(comparisonData.pdfs[currentPdf].pages).map(Number).sort((a,b) => a-b);
            const idx = pages.indexOf(currentPage);
            if (idx > 0) {
                currentPage = pages[idx - 1];
                document.getElementById('page-select').value = currentPage;
                renderComparison();
            }
        }
        
        function nextPage() {
            if (!currentPdf || !comparisonData.pdfs[currentPdf]) return;
            const pages = Object.keys(comparisonData.pdfs[currentPdf].pages).map(Number).sort((a,b) => a-b);
            const idx = pages.indexOf(currentPage);
            if (idx < pages.length - 1) {
                currentPage = pages[idx + 1];
                document.getElementById('page-select').value = currentPage;
                renderComparison();
            }
        }
        
        function renderComparison() {
            if (!currentPdf || !currentPage) {
                return;
            }
            
            const pdfData = comparisonData.pdfs[currentPdf];
            const pageData = pdfData.pages[currentPage];
            
            if (!pageData) {
                document.getElementById('original-panel').innerHTML = '<div class="no-data">No data for this page</div>';
                document.getElementById('traditional-panel').innerHTML = '<div class="no-data">No data for this page</div>';
                document.getElementById('multimodal-panel').innerHTML = '<div class="no-data">No data for this page</div>';
                return;
            }
            
            // Render original page image
            if (pageData.image) {
                document.getElementById('original-panel').innerHTML = 
                    `<img class="page-image" src="data/${pageData.image}" alt="Page ${currentPage}">`;
            } else {
                document.getElementById('original-panel').innerHTML = '<div class="no-data">No image available</div>';
            }
            
            // Render traditional extraction
            renderTraditional(pageData.traditional);
            
            // Render multimodal extraction
            renderMultimodal(pageData.multimodal);
        }
        
        function renderTraditional(data) {
            if (!data) {
                document.getElementById('traditional-panel').innerHTML = '<div class="no-data">No traditional extraction data</div>';
                return;
            }
            
            let html = `
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value">${data.text_length || 0}</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${data.image_count || 0}</div>
                        <div class="stat-label">Images Detected</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${data.block_count || 0}</div>
                        <div class="stat-label">Text Blocks</div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-title">Extracted Text</div>
                    <div class="extraction-text">${escapeHtml(data.text || 'No text extracted')}</div>
                </div>
            `;
            
            document.getElementById('traditional-panel').innerHTML = html;
        }
        
        function getModelBadgeClass(modelDisplay) {
            if (!modelDisplay) return '';
            const lower = modelDisplay.toLowerCase();
            if (lower.includes('gemini')) return 'gemini';
            if (lower.includes('gemma')) return 'gemma';
            if (lower.includes('mistral')) return 'mistral';
            if (lower.includes('nemotron')) return 'nemotron';
            if (lower.includes('nova')) return 'nova';
            return '';
        }
        
        function renderMultimodal(data) {
            if (!data) {
                document.getElementById('multimodal-panel').innerHTML = '<div class="no-data">No multimodal extraction data</div>';
                document.getElementById('multimodal-header').textContent = 'Multimodal Extraction';
                return;
            }
            
            // Update header with model name
            const modelDisplay = data.model_display || 'Unknown Model';
            document.getElementById('multimodal-header').textContent = `Multimodal (${modelDisplay})`;
            
            if (data.error) {
                const badgeClass = getModelBadgeClass(modelDisplay);
                document.getElementById('multimodal-panel').innerHTML = `
                    <div class="model-badge error ${badgeClass}">${escapeHtml(modelDisplay)} - ERROR</div>
                    <div class="no-data">Error: ${escapeHtml(data.message || 'Unknown error')}</div>
                `;
                return;
            }
            
            let html = '';
            
            // Model badge - prominent at top
            const badgeClass = getModelBadgeClass(modelDisplay);
            html += `<div class="model-badge ${badgeClass}">${escapeHtml(modelDisplay)}</div>`;
            
            // Page type
            if (data.page_type) {
                html += `<div class="section"><strong>Page Type:</strong> ${escapeHtml(data.page_type)}</div>`;
            }
            
            // Key concepts
            if (data.key_concepts && data.key_concepts.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Key Concepts</div>
                        <div class="key-concepts">
                            ${data.key_concepts.map(c => `<span class="concept-tag">${escapeHtml(c)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Methods mentioned
            if (data.methods_mentioned && data.methods_mentioned.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Methods/Models</div>
                        <div class="key-concepts">
                            ${data.methods_mentioned.map(m => `<span class="concept-tag" style="background:#8e44ad">${escapeHtml(m)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Datasets mentioned
            if (data.datasets_mentioned && data.datasets_mentioned.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Datasets</div>
                        <div class="key-concepts">
                            ${data.datasets_mentioned.map(d => `<span class="concept-tag" style="background:#16a085">${escapeHtml(d)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Metrics reported
            if (data.metrics_reported && data.metrics_reported.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Metrics Reported</div>
                        <div class="metrics-grid">
                            ${data.metrics_reported.map(m => `
                                <div class="metric-item">
                                    <span class="metric-name">${escapeHtml(m.metric || '')}:</span>
                                    <span class="metric-value">${escapeHtml(m.value || '')}</span>
                                    ${m.context ? `<br><small>${escapeHtml(m.context)}</small>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Citations
            if (data.citations_mentioned && data.citations_mentioned.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Citations Mentioned</div>
                        <div class="key-concepts">
                            ${data.citations_mentioned.map(c => `<span class="citation-tag">${escapeHtml(c)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Visual Elements (new format)
            if (data.visual_elements && data.visual_elements.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Visual Elements (${data.visual_elements.length})</div>
                        ${data.visual_elements.map(v => `
                            <div class="visual-element ${v.type || ''}">
                                <span class="type-tag">${escapeHtml(v.type || 'unknown')}</span>
                                ${v.number ? `<strong>${escapeHtml(v.number)}</strong>` : ''}
                                ${v.caption ? `<div class="caption">${escapeHtml(v.caption)}</div>` : ''}
                                <div class="description">${escapeHtml(v.description || 'No description')}</div>
                                ${v.components && v.components.length > 0 ? `
                                    <div style="margin-top:5px;font-size:11px">
                                        <strong>Components:</strong> ${v.components.map(c => escapeHtml(c)).join(', ')}
                                    </div>
                                ` : ''}
                                ${v.data_summary ? `
                                    <div style="margin-top:5px;font-size:11px">
                                        <strong>Data:</strong> ${escapeHtml(v.data_summary)}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Legacy figures format (backward compatibility)
            if (data.figures && data.figures.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Figures (${data.figures.length})</div>
                        ${data.figures.map(f => `
                            <div class="figure-item">
                                <div class="caption">Figure ${f.number}: ${escapeHtml(f.caption || '')}</div>
                                <div class="description">${escapeHtml(f.description || 'No description')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Structured tables
            if (data.tables_structured && data.tables_structured.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Tables (${data.tables_structured.length})</div>
                        ${data.tables_structured.map(t => `
                            <div class="figure-item">
                                <div class="caption">${escapeHtml(t.number || 'Table')}: ${escapeHtml(t.caption || '')}</div>
                                ${t.headers ? `<div style="font-size:11px;margin-top:5px"><strong>Headers:</strong> ${t.headers.map(h => escapeHtml(h)).join(' | ')}</div>` : ''}
                                ${t.key_findings ? `<div style="font-size:11px;margin-top:5px"><strong>Key findings:</strong> ${escapeHtml(t.key_findings)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Legacy tables format (backward compatibility)
            if (data.tables && data.tables.length > 0 && !data.tables_structured) {
                html += `
                    <div class="section">
                        <div class="section-title">Tables (${data.tables.length})</div>
                        ${data.tables.map(t => `
                            <div class="figure-item">
                                <div class="caption">Table ${t.number}: ${escapeHtml(t.caption || '')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Equations
            if (data.equations && data.equations.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Equations (${data.equations.length})</div>
                        ${data.equations.map(e => `
                            <div class="figure-item">
                                ${e.latex ? `<code style="background:#f0f0f0;padding:2px 5px">${escapeHtml(e.latex)}</code>` : ''}
                                <div class="description">${escapeHtml(e.description || '')}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Extracted images from PDF
            if (data.extracted_images && data.extracted_images.length > 0) {
                html += `
                    <div class="section">
                        <div class="section-title">Extracted Images (${data.extracted_images.length})</div>
                        <div class="extracted-images">
                            ${data.extracted_images.map(img => `
                                <div class="extracted-image-item">
                                    <img src="data/images/${img.filename}" alt="${escapeHtml(img.filename)}" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                    <div style="display:none;color:#999;font-size:10px">Image not found</div>
                                    <div class="img-info">
                                        ${img.width}x${img.height} ${img.format}<br>
                                        ${(img.size_bytes / 1024).toFixed(1)} KB
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Text content
            if (data.text_content) {
                html += `
                    <div class="section">
                        <div class="section-title">Extracted Text</div>
                        <div class="extraction-text">${escapeHtml(data.text_content)}</div>
                    </div>
                `;
            }
            
            if (!html) {
                html = '<div class="no-data">No structured data extracted</div>';
            }
            
            document.getElementById('multimodal-panel').innerHTML = html;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>
